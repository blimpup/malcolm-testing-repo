#! /usr/bin/env python

import os
import sys

import json
import yaml

repo_config = json.load(sys.stdin)

with open(os.path.join(os.environ['TERRATEAM_ROOT'], '.terrateam', 'deps.yml')) as f:
    deps = yaml.safe_load(f)

dep_dirs = deps.get('dirs', {})

for d in repo_config.get('dirs', {}):
    if d in dep_dirs:
        deps_list = dep_dirs[d].get('deps', [])
        depends_on = ' or '.join(['dir:' + dir for dir in deps_list])
        repo_config.setdefault('dirs', {})[d].setdefault('when_modified', {})['depends_on'] = depends_on

print(json.dumps(repo_config, indent=2))
